<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helpdesk Scheduling App</title>
    <!-- Updated w2ui CSS link -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/w2ui@2.0/w2ui-2.0.min.css">
    <style>
        /* Add some basic styling */
        body { font-family: Arial, sans-serif; margin: 20px; }
        #grid { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Helpdesk Scheduling App</h1>
    <div id="grid" style="width: 100%; height: 400px;"></div>

    <!-- Updated script sources and order -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/w2ui@2.0/w2ui-2.0.min.js"></script>
    <script>
        $(function () {
            // Initialize the grid
            $('#grid').w2grid({
                name: 'scheduleGrid',
                header: 'Weekly Schedule Overview',
                columns: [
                    { field: 'hour',text:"Hour", caption: 'Hour', size: '100px' },
                    { field: 'sunday',text: 'Sunday', caption: 'Sunday', size: '100px' },
                    { field: 'monday',text: 'Monday', caption: 'Monday', size: '100px' },
                    { field: 'tuesday',text: 'Tuesday', caption: 'Tuesday', size: '100px' },
                    { field: 'wednesday',text: 'Wednesday', caption: 'Wednesday', size: '100px' },
                    { field: 'thursday', text: 'Thursday', caption: 'Thursday', size: '100px' },
                    { field: 'friday',text: 'Friday', caption: 'Friday', size: '100px' },
                    { field: 'saturday',text: 'Saturday', caption: 'Saturday', size: '100px' }
                ],
                records: []
            });

            // Function to fetch and update the schedule
            function updateSchedule() {
                fetch('/api/work-positions')
                    .then(response => response.json())
                    .then(workPositions => {
                        const schedule = new Array(24).fill(0).map(() => new Array(7).fill(0));

                        workPositions.forEach(position => {
                            position.schedule.forEach(shift => {
                                for (let hour = shift.startHour; hour < shift.endHour; hour++) {
                                    schedule[hour][shift.day]++;
                                }
                            });
                        });

                        const records = schedule.map((row, hour) => ({
                            recid: hour,
                            hour: `${hour}:00 - ${hour + 1}:00`,
                            sunday: row[0],
                            monday: row[1],
                            tuesday: row[2],
                            wednesday: row[3],
                            thursday: row[4],
                            friday: row[5],
                            saturday: row[6]
                        }));

                        w2ui['scheduleGrid'].records = records;
                        w2ui['scheduleGrid'].refresh();
                    })
                    .catch(error => console.error('Error fetching schedule:', error));
            }

            // Initial update
            updateSchedule();

            // Update every 5 minutes
            setInterval(updateSchedule, 5 * 60 * 1000);
        });
    </script>
</body>
</html>